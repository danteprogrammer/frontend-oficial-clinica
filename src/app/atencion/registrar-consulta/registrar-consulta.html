<div class="form-container">
    <h2>Registro de Consulta Médica</h2>

    <div class="buscador-paciente">
        <div class="form-group">
            <label for="pacienteBusqueda">Buscar Paciente por DNI o Nombre</label>
            <input id="pacienteBusqueda" type="text" [formControl]="pacienteBusquedaControl" placeholder="Escriba para buscar...">
        </div>

        <div *ngIf="pacientesEncontrados.length > 0" class="resultados-busqueda">
            <div *ngFor="let paciente of pacientesEncontrados" class="resultado-item" (click)="seleccionarPaciente(paciente)">
                {{ paciente.nombres }} {{ paciente.apellidos }} - DNI: {{ paciente.dni }}
            </div>
        </div>

        <div *ngIf="pacienteSeleccionado" class="paciente-seleccionado">
            <h4>Paciente: <strong>{{ pacienteSeleccionado.nombres }} {{ pacienteSeleccionado.apellidos }}</strong></h4>
            <span *ngIf="idHistoriaClinicaSeleccionada">H.C. N°: {{ idHistoriaClinicaSeleccionada }}</span>
        </div>
    </div>

    <div *ngIf="cargandoTriaje" class="loading-triaje">
        Cargando datos de Triaje...
    </div>

    <div *ngIf="!cargandoTriaje && pacienteSeleccionado && ultimoTriaje" class="card card-triaje">
        <div class="card-header">
            <h4><i class="fas fa-notes-medical"></i> Datos de Triaje (Del {{ ultimoTriaje.fechaRegistro | date:'dd/MM/yyyy HH:mm' }})</h4>
        </div>
        <div class="card-body">
            <div class="triaje-datos">
                <div class="dato-item">
                    <span class="etiqueta">Peso:</span>
                    <span class="valor">{{ ultimoTriaje.peso | number:'1.1-2' }} kg</span>
                </div>
                <div class="dato-item">
                    <span class="etiqueta">Altura:</span>
                    <span class="valor">{{ ultimoTriaje.altura }} cm</span>
                </div>
                <div class="dato-item">
                    <span class="etiqueta">IMC:</span>
                    <span class="valor">{{ ultimoTriaje.imc | number:'1.1-2' }}</span>
                </div>
                <div class="dato-item">
                    <span class="etiqueta">P. Arterial:</span>
                    <span class="valor">{{ ultimoTriaje.presionArterial }}</span>
                </div>
                <div class="dato-item">
                    <span class="etiqueta">Temp.:</span>
                    <span class="valor">{{ ultimoTriaje.temperatura | number:'1.1-1' }} °C</span>
                </div>
                <div class="dato-item">
                    <span class="etiqueta">Sat. O₂:</span>
                    <span class="valor">{{ ultimoTriaje.saturacionOxigeno }} %</span>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="!cargandoTriaje && pacienteSeleccionado && !ultimoTriaje" class="no-triaje">
        <i class="fas fa-exclamation-triangle"></i>
        El paciente no tiene ningún registro de triaje.
    </div>

    <form [formGroup]="consultaForm" (ngSubmit)="onSubmit()" *ngIf="pacienteSeleccionado">
        
        <h4>Detalles de la Consulta</h4>
        <div class="form-grid">
            <div class="form-group full-width">
                <label for="motivo">Motivo de la Consulta</label>
                <textarea id="motivo" formControlName="motivo" rows="3" required></textarea>
            </div>
            <div class="form-group full-width">
                <label for="diagnostico">Diagnóstico</label>
                <textarea id="diagnostico" formControlName="diagnostico" rows="5" required></textarea>
            </div>
            <div class="form-group full-width">
                <label for="tratamiento">Tratamiento y Receta</label>
                <textarea id="tratamiento" formControlName="tratamiento" rows="5"></textarea>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn-cancelar" (click)="limpiarFormulario()">Limpiar</button>
            <button type="submit" [disabled]="consultaForm.invalid || cargando">
                {{ cargando ? 'Guardando...' : 'Guardar Consulta' }}
            </button>
        </div>
    </form>
</div>