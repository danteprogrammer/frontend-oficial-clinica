<div class="historial-container">
    <h2><i class="fas fa-book-medical"></i> Historial Clínico del Paciente</h2>

    <div class="card-busqueda">
        <h4>1. Buscar Paciente</h4>
        <div class="search-form-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="form-control" placeholder="Buscar por DNI o Nombre del paciente..."
                [formControl]="pacienteBusquedaControl">

            <button *ngIf="pacienteSeleccionado" (click)="limpiarPaciente()" class="btn-limpiar-paciente">
                Limpiar
            </button>

            <div *ngIf="pacientesEncontrados.length > 0" class="resultados-busqueda">
                <div *ngFor="let p of pacientesEncontrados" class="resultado-item" (click)="seleccionarPaciente(p)">
                    <strong>{{ p.nombres }} {{ p.apellidos }}</strong> (DNI: {{ p.dni }})
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="pacienteSeleccionado">

        <div class="info-paciente card">
            <div class="card-header">
                <h3>Datos del Paciente</h3>
            </div>
            <div class="card-body">
                <p><strong>Paciente:</strong> {{ pacienteSeleccionado.nombres }} {{ pacienteSeleccionado.apellidos }}
                </p>
                <p><strong>DNI:</strong> {{ pacienteSeleccionado.dni }}</p>
                <p><strong>Edad:</strong> {{ transformDateToAge(pacienteSeleccionado.fechaNacimiento) }} años</p>
                <p><strong>N° Historia Clínica:</strong> {{ idHistoriaClinicaSeleccionada || 'N/A' }}</p>
            </div>
        </div>

        <div *ngIf="cargandoHistorial" class="loading-container">
            Cargando historial...
        </div>

        <div *ngIf="error" class="error-container">
            {{ error }}
        </div>

        <div *ngIf="!cargandoHistorial && !error">
            <div class="historial-section">
                <h3><i class="fas fa-stethoscope"></i> Consultas Anteriores</h3>
                <div *ngIf="consultas.length === 0" class="no-data">
                    No hay consultas registradas.
                </div>

                <div class="timeline" *ngIf="consultas.length > 0">
                    <div *ngFor="let c of consultas" class="timeline-item">
                        <div class="timeline-date">
                            {{ c.fechaConsulta | date:'dd/MM/yyyy' }}
                        </div>
                        <div class="timeline-content card">
                            <div class="card-header">
                                <strong>{{ c.medico.especialidad }}</strong>
                                <span class="medico-info">Atendido por: {{ c.medico.sexo === 'Femenino' ? 'Dra.' : 'Dr.'
                                    }} {{ c.medico.nombres }} {{ c.medico.apellidos }}</span>
                            </div>
                            <div class="card-body">
                                <div class="consulta-detalle">
                                    <strong>Motivo:</strong>
                                    <p>{{ c.motivo }}</p>
                                </div>
                                <div class="consulta-detalle">
                                    <strong>Diagnóstico:</strong>
                                    <p>{{ c.diagnostico }}</p>
                                </div>
                                <div class="consulta-detalle">
                                    <strong>Tratamiento/Indicaciones:</strong>
                                    <pre class="tratamiento-text">{{ c.tratamiento }}</pre>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn-accion btn-ver-pdf" (click)="verReceta(c)">
                                    <i class="fas fa-print"></i> Ver Receta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="historial-section">
                <h3><i class="fas fa-vial"></i> Exámenes de Laboratorio</h3>
                <div *ngIf="ordenesLab.length === 0" class="no-data">
                    No hay exámenes de laboratorio registrados.
                </div>

                <div class="table-container" *ngIf="ordenesLab.length > 0">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Exámenes Solicitados</th>
                                <th>Resultados</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let o of ordenesLab">
                                <td>{{ o.fecha | date:'dd/MM/yyyy HH:mm' }}h</td>
                                <td>
                                    <pre classm="examenes-text">{{ o.examenes }}</pre>
                                </td>
                                <td>
                                    <pre *ngIf="o.resultados" class="resultados-text">{{ o.resultados }}</pre>
                                    <span *ngIf="!o.resultados" class="no-data-small">Aún no disponible</span>
                                </td>
                                <td>
                                    <span class="badge" [ngClass]="{
                                        'badge-pendiente': o.estado === 'PENDIENTE',
                                        'badge-en_proceso': o.estado === 'EN_PROCESO',
                                        'badge-completado': o.estado === 'COMPLETADO',
                                        'badge-cancelado': o.estado === 'CANCELADO'
                                    }">
                                        {{ o.estado }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>