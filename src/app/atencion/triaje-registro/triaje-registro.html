<div class="triaje-container">
  <h2>Registro de Triaje</h2>

  <div *ngIf="!pacienteSeleccionado">
    <div class="card card-busqueda">
      <div class="card-body">
        <div class="form-group" style="position: relative;">
          <label for="pacienteBusqueda">Buscar Paciente por DNI o Nombre</label>
          <input id="pacienteBusqueda" type="text" [formControl]="pacienteBusquedaControl"
            placeholder="Escriba para buscar..." class="form-control">
        </div>
      </div>
    </div>

    <div *ngIf="pacientesEncontrados.length > 0" class="table-container-pacientes">
      <table class="tabla-paciente-seleccion">
        <thead>
          <tr>
            <th>DNI</th>
            <th>Nombre Completo</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let paciente of pacientesEncontrados" (click)="seleccionarPaciente(paciente)"
            class="resultado-item-fila">
            <td>{{ paciente.dni }}</td>
            <td>{{ paciente.nombres }} {{ paciente.apellidos }}</td>
            <td>
              <button type="button" class="btn-seleccionar-sm">
                Seleccionar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>


  <div *ngIf="pacienteSeleccionado">

    <div class="card-paciente-seleccionado">
      <div>
        <h4><i class="fas fa-user-check"></i> Paciente Seleccionado</h4>
        <p>
          <strong>{{ pacienteSeleccionado.nombres }} {{ pacienteSeleccionado.apellidos }}</strong>
          (DNI: {{ pacienteSeleccionado.dni }})
          <span *ngIf="idHistoriaClinica"> - H.C. N°: {{ idHistoriaClinica }}</span>
        </p>
      </div>
      <button class="btn-cambiar" (click)="limpiarPaciente()">
        <i class="fas fa-exchange-alt"></i> Cambiar Paciente
      </button>
    </div>


    <div class="triaje-content" *ngIf="idHistoriaClinica">

      <div class="card card-registro">
        <div class="card-header">
          <h4>Registrar Signos Vitales</h4>
        </div>
        <div class="card-body">
          <form [formGroup]="triajeForm" (ngSubmit)="onSubmit()">
            <div class="form-grid">
              <div class="form-group">
                <label for="peso">Peso (kg)</label>
                <input id="peso" type="number" formControlName="peso" class="form-control"
                  [class.is-invalid]="f['peso'].touched && f['peso'].errors">
              </div>

              <div class="form-group">
                <label for="altura">Altura (cm)</label>
                <input id="altura" type="number" formControlName="altura" class="form-control"
                  [class.is-invalid]="f['altura'].touched && f['altura'].errors">
              </div>

              <div class="form-group">
                <label for="imc">IMC (kg/m²)</label>
                <input id="imc" type="text" [value]="imcCalculado | number:'1.1-2'" class="form-control" disabled>
              </div>

              <div class="form-group">
                <label for="presionSistolica">P. Sistólica (mmHg)</label>
                <input id="presionSistolica" type="number" formControlName="presionSistolica" class="form-control"
                  [class.is-invalid]="f['presionSistolica'].touched && f['presionSistolica'].errors"
                  placeholder="Ej: 120">
              </div>

              <div class="form-group">
                <label for="presionDiastolica">P. Diastólica (mmHg)</label>
                <input id="presionDiastolica" type="number" formControlName="presionDiastolica" class="form-control"
                  [class.is-invalid]="f['presionDiastolica'].touched && f['presionDiastolica'].errors"
                  placeholder="Ej: 80">
              </div>
              <div class="form-group">
                <label for="temperatura">Temperatura (°C)</label>
                <input id="temperatura" type="number" formControlName="temperatura" class="form-control"
                  [class.is-invalid]="f['temperatura'].touched && f['temperatura'].errors">
              </div>

              <div class="form-group">
                <label for="saturacionOxigeno">Saturación O₂ (%)</label>
                <input id="saturacionOxigeno" type="number" formControlName="saturacionOxigeno" class="form-control"
                  [class.is-invalid]="f['saturacionOxigeno'].touched && f['saturacionOxigeno'].errors">
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" (click)="limpiarFormulario()">Limpiar</button>
              <button type="submit" class="btn btn-success" [disabled]="triajeForm.invalid || cargando">
                {{ cargando ? 'Guardando...' : 'Guardar Triaje' }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="card card-historial">
        <div class="card-header">
          <h4>Historial de Triajes</h4>
        </div>
        <div class="card-body">
          <div *ngIf="cargando" class="loading-historial">Cargando historial...</div>

          <div *ngIf="!cargando && historialTriajes.length === 0" class="no-historial">
            Este paciente no tiene registros de triaje anteriores.
          </div>

          <div class="table-container" *ngIf="!cargando && historialTriajes.length > 0">
            <table>
              <thead>
                <tr>
                  <th>Fecha y Hora</th>
                  <th>Peso</th>
                  <th>Altura</th>
                  <th>IMC</th>
                  <th>P. Arterial</th>
                  <th>Temp.</th>
                  <th>Sat. O₂</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let triaje of historialTriajes">
                  <td>{{ triaje.fechaRegistro | date:'dd/MM/yy HH:mm' }}</td>
                  <td>{{ triaje.peso }} kg</td>
                  <td>{{ triaje.altura }} cm</td>
                  <td>{{ triaje.imc }}</td>
                  <td>{{ triaje.presionArterial }}</td>
                  <td>{{ triaje.temperatura }} °C</td>
                  <td>{{ triaje.saturacionOxigeno }} %</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div> </div>