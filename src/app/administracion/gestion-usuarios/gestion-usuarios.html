<div class="admin-container">
    <h2><i class="fas fa-users-cog"></i> Gestión de Usuarios y Roles</h2>

    <div class="form-card">
        <h3>{{ modoEdicion ? 'Editar Usuario' : 'Registrar Nuevo Usuario' }}</h3>
        <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()">
            <div class="form-grid">

                <div class="form-group">
                    <label for="nombres">Nombres</label>
                    <input id="nombres" type="text" formControlName="nombres"
                        [class.is-invalid]="esCampoInvalido('nombres')">
                    <div *ngIf="esCampoInvalido('nombres')" class="invalid-feedback">Campo requerido.</div>
                </div>

                <div class="form-group">
                    <label for="apellidos">Apellidos</label>
                    <input id="apellidos" type="text" formControlName="apellidos"
                        [class.is-invalid]="esCampoInvalido('apellidos')">
                    <div *ngIf="esCampoInvalido('apellidos')" class="invalid-feedback">Campo requerido.</div>
                </div>

                <div class="form-group">
                    <label for="nombreUsuario">Nombre de Usuario (login)</label>
                    <input id="nombreUsuario" type="text" formControlName="nombreUsuario"
                        [class.is-invalid]="esCampoInvalido('nombreUsuario')">
                    <div *ngIf="esCampoInvalido('nombreUsuario')" class="invalid-feedback">Campo requerido.</div>
                </div>

                <div class="form-group">
                    <label for="clave">Contraseña</label>
                    <input id="clave" type="password" formControlName="clave"
                        [placeholder]="modoEdicion ? 'Dejar en blanco para no cambiar' : 'Requerido al crear'">
                </div>

                <div class="form-group">
                    <label for="idRol">Rol</label>
                    <select id="idRol" formControlName="idRol" [class.is-invalid]="esCampoInvalido('idRol')">
                        <option [value]="null" disabled>Seleccione un rol...</option>
                        <option *ngFor="let rol of roles" [value]="rol.idRol">{{ rol.nombre }}</option>
                    </select>
                    <div *ngIf="esCampoInvalido('idRol')" class="invalid-feedback">Debe seleccionar un rol.</div>
                </div>

                <div class="form-group">
                    <label for="estado">Estado</label>
                    <select id="estado" formControlName="estado">
                        <option value="ACTIVO">Activo</option>
                        <option value="INACTIVO">Inactivo</option>
                    </select>
                </div>

                <div class="form-group full-width" *ngIf="esRolMedico">
                    <label for="idMedico">Enlazar a Perfil de Médico</label>
                    <select id="idMedico" formControlName="idMedico">
                        <option [value]="null">No enlazar</option>
                        <option *ngFor="let medico of medicos" [value]="medico.idMedico">
                            Dr. {{ medico.nombres }} {{ medico.apellidos }} (DNI: {{medico.dni}})
                        </option>
                    </select>
                    <small>Seleccione el perfil profesional al que esta cuenta de login tendrá acceso.</small>
                </div>

            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancelar" (click)="resetFormulario()">Cancelar</button>
                <button type="submit" [disabled]="!usuarioForm.valid && !modoEdicion">
                    <span *ngIf="!cargando">{{ modoEdicion ? 'Actualizar Usuario' : 'Crear Usuario' }}</span>
                    <span *ngIf="cargando">Guardando...</span>
                </button>
            </div>
        </form>
    </div>

    <div class="table-container">
        <h3>Lista de Usuarios</h3>
        <div *ngIf="cargando" class="loading-container">Cargando usuarios...</div>
        <div *ngIf="error" class="error-container">{{ error }}</div>

        <table *ngIf="!cargando && !error && usuarios.length > 0">
            <thead>
                <tr>
                    <th>Nombre Completo</th>
                    <th>Usuario (login)</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Enlazado a</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of usuarios">
                    <td>{{ user.nombres }} {{ user.apellidos }}</td>
                    <td>{{ user.nombreUsuario }}</td>
                    <td><span class="badge badge-rol">{{ user.rolNombre }}</span></td>
                    <td>
                        <span class="badge" [ngClass]="{
                            'badge-success': user.estado === 'ACTIVO',
                            'badge-danger': user.estado === 'INACTIVO'
                        }">
                            {{ user.estado }}
                        </span>
                    </td>
                    <td>{{ user.medicoAsociado }}</td>
                    <td class="acciones">
                        <button class="btn-accion btn-editar" (click)="cargarUsuarioParaEditar(user)">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn-accion btn-eliminar" (click)="inactivarUsuario(user)"
                            [disabled]="user.estado === 'INACTIVO' || user.rolNombre === 'ADMIN'">
                            <i class="fas fa-ban"></i> Inactivar
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>